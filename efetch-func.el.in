;;; efetch-func.el --- Efetch functions.             -*- lexical-binding: t; -*-

;; Copyright (C) 2018  Pierre-Antoine Rouby

;; Author: Pierre-Antoine Rouby <prouby@fry>
;; Keywords: lisp, extensions

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see <https://www.gnu.org/licenses/>.

;;; Commentary:

;; Eftech functions.

;;; Code:

(defvar ef-images-dir "@INST_IMAGES_DIR@")

(defun ef-display (msg str)
  "Display new line in eftech buffer."
  (insert (concat msg " : " str "\n")))

(defun ef-uname (opt)
  "Exec uname with 'opt' and return the first line of command
output."
  (car (split-string
        (shell-command-to-string (format "uname %s" opt))
        "\n")))

(defun ef-shell ()
  "Return shell name."
  (capitalize (file-name-nondirectory (getenv "SHELL"))))


(defun ef-guix-version ()
  "Return Guix version."
  (capitalize (car                      ;First line
               (split-string            ;Split by line
                (shell-command-to-string "guix --version")
                "\n"))))

(defun ef-distro ()
  "Return operation system name and version."
  (cond
   ;; lsb_release
   ((eq (shell-command "type -p lsb_release") 0)
    (shell-command-to-string "lsb_release -sd"))
   ;; Guix
   ((eq (shell-command "type -p guix") 0)
    (concat "GuixSD "
            (nth 4 (split-string
                    (shell-command-to-string
                     "guix system -V")
                    " \\|\n"))))
   ;; Default
   (t "Unknown OS")))

(defun efetch ()
  "Display emacs and system configuration in new buffer."
  (interactive)
  (let* ((buff  (generate-new-buffer "efetch"))
         (os             (ef-distro))
         (kernel         (ef-uname "-s"))
         (kernel-version (ef-uname "-r"))
         (kernel-arch    (ef-uname "-m"))
         (shell-name     (ef-shell))
         (emacs-info (split-string (emacs-version)))
         (emacs-short-info (concat (nth 0 emacs-info) " "
                                   (nth 1 emacs-info) " "
                                   (nth 2 emacs-info)))
         (guix-version   (ef-guix-version)))
    ;; Switch to new buffer and active efetch-mode
    (set-buffer buff)
    (switch-to-buffer buff)
    (efetch-mode)

    ;; Insert data
    (insert "+++ Efetch +++\n")

    (insert-image
     (create-image (concat ef-images-dir "/default.png")))
    (insert "\n")

    (ef-display "OS             " os)
    (ef-display "Architecture   " kernel-arch)
    (ef-display "Kernel         " kernel)
    (ef-display "System         " system-configuration)
    (ef-display "Host           " (system-name))
    (ef-display "Kernel         " kernel-version)
    (ef-display "Shell          " shell-name)
    (if (file-exists-p "~/.guix-profile")
        (ef-display "Guix           " guix-version))
    (ef-display "Emacs version  " emacs-short-info)
    (ef-display "Emacs uptime   " (emacs-uptime))

    ;; Set buffer to read only mode
    (read-only-mode)))

(provide 'efetch-func)
;;; efetch-func.el ends here
