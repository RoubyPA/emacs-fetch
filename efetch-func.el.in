;;; efetch-func.el --- Efetch functions.             -*- lexical-binding: t; -*-

;; Copyright (C) 2018  Pierre-Antoine Rouby

;; Author: Pierre-Antoine Rouby <prouby@fry>
;; Keywords: lisp, extensions

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see <https://www.gnu.org/licenses/>.

;;; Commentary:

;; Eftech functions.

;;; Code:

(defvar ef-images-dir "@INST_IMAGES_DIR@")
(defvar ef-default-spaces 15)
(defvar ef-default-separator " : ")

(defun ef-add-spaces (str n)
  (if (= n 0)
      str
    (ef-add-spaces (concat str " ") (- n 1))))

(defun ef-display (l)
  "Display new line in eftech buffer."
  (insert
   (concat (ef-add-spaces (car l) (- ef-default-spaces (length (car l))))
           ef-default-separator (cdr l) "\n")))

(defun ef-emacs-info ()
  (let ((emacs-info (split-string (emacs-version))))
    (concat (nth 0 emacs-info) " "
            (nth 1 emacs-info) " "
            (nth 2 emacs-info))))

(defun ef-uname (opt)
  "Exec uname with 'opt' and return the first line of command
output."
  (car (split-string
        (shell-command-to-string (format "uname %s" opt))
        "\n")))

(defun ef-shell ()
  "Return shell name."
  (capitalize (file-name-nondirectory (getenv "SHELL"))))

(defun ef-distro ()
  "Return operation system name and version."
  (cond
   ;; lsb_release
   ((eq (shell-command "type -p lsb_release") 0)
    (shell-command-to-string "lsb_release -sd"))
   ;; Guix
   ((eq (shell-command "type -p guix") 0)
    (concat "GuixSD "
            (nth 4 (split-string
                    (shell-command-to-string
                     "guix system -V")
                    " \\|\n"))))
   ;; Default
   (t "Unknown OS")))

(defun efetch ()
  "Display emacs and system configuration in new buffer."
  (interactive)
  (let* ((buff  (generate-new-buffer "efetch"))
         (data  `(("OS"     . ,(ef-distro))
                  ("Host"   . ,(system-name))
                  ("Kernel" . ,(ef-uname "-s"))
                  ("Kernel version" . ,(ef-uname "-r"))
                  ("Arch"   . ,(ef-uname "-m"))
                  ("Shell"  . ,(ef-shell))
                  ("Emacs"  . ,(ef-emacs-info))
                  ("Emacs uptime" . ,(emacs-uptime)))))
    ;; Switch to new buffer and active efetch-mode
    (set-buffer buff)
    (switch-to-buffer buff)
    (efetch-mode)

    ;; Insert data
    (insert "+++ Efetch +++\n")

    (insert-image
     (create-image (concat ef-images-dir "/default.png")))
    (insert "\n")

    (mapc 'ef-display data)

    ;; Set buffer to read only mode
    (read-only-mode)))

(provide 'efetch-func)
;;; efetch-func.el ends here
